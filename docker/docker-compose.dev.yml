# =============================================================================
# MMG Service Platform - DEVELOPMENT/STAGING Docker Compose
# =============================================================================
# FOR: Development/staging environments (cloud or self-hosted dev servers)
# DOCKERFILE: Uses render/Dockerfile to mirror Render deployments
#
# DO NOT USE FOR:
# - Local development (use docker-compose.local.yml)
# - Production deployments (use docker-compose.yml)
#
# This is useful for:
# - Staging environments that mirror production
# - Dev servers on cloud (AWS dev, GCP dev, etc.)
# - CI/CD testing pipelines
# - Pre-production verification
#
# QUICK START (run from repo root):
#   docker-compose -f docker/docker-compose.dev.yml --env-file .env.development up -d
#   docker-compose -f docker/docker-compose.dev.yml --env-file .env.development up -d --build
#
# SELECTIVE SERVICES (using profiles):
#   docker-compose -f docker/docker-compose.dev.yml --profile sales up -d
#   docker-compose -f docker/docker-compose.dev.yml --profile ui up -d
#   docker-compose -f docker/docker-compose.dev.yml --profile assets up -d
#   docker-compose -f docker/docker-compose.dev.yml --profile security up -d
#   docker-compose -f docker/docker-compose.dev.yml --profile video up -d
#   docker-compose -f docker/docker-compose.dev.yml --profile all up -d
#
# MANAGEMENT:
#   docker-compose -f docker/docker-compose.dev.yml logs -f
#   docker-compose -f docker/docker-compose.dev.yml ps
#   docker-compose -f docker/docker-compose.dev.yml down
#   docker-compose -f docker/docker-compose.dev.yml down -v
#
# ACCESS POINTS (default ports):
#   - Unified UI:        http://localhost:3005
#   - Proposal Bot:      http://localhost:8000
#   - Asset Management:  http://localhost:8001
#   - Security Service:  http://localhost:8002
#   - Video Critique:    http://localhost:8003
#
# =============================================================================

services:
  # ===========================================================================
  # Proposal Bot Backend (FastAPI) - Sales Module
  # ===========================================================================
  proposal-bot:
    build:
      context: ../src/sales-module
      dockerfile: render/Dockerfile  # Render-style Dockerfile for dev/staging
      args:
        - ENVIRONMENT=${ENVIRONMENT:-development}
    image: ${SALES_IMAGE:-crm-proposal-bot:dev}
    container_name: ${SALES_CONTAINER_NAME:-proposal-bot-dev}
    restart: unless-stopped
    profiles:
      - all
      - sales
    ports:
      - "${SALES_PORT:-8000}:8000"
    env_file:
      - ${SALES_ENV_FILE:-../.env.development}
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8000
      DB_BACKEND: supabase
      STORAGE_PROVIDER: supabase
      AUTH_PROVIDER: supabase
      PROXY_SECRET: ${PROXY_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
    volumes:
      - ${SALES_DATA_VOLUME:-sales-data-dev}:/data
      - ${SALES_UPLOADS_PATH:-../src/sales-module/uploads}:/app/uploads
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Unified UI Frontend (FastAPI) - Auth Gateway + SPA
  # ===========================================================================
  unified-ui:
    build:
      context: ../src/unified-ui
      dockerfile: render/Dockerfile  # Render-style Dockerfile for dev/staging
      args:
        - ENVIRONMENT=${ENVIRONMENT:-development}
    image: ${UI_IMAGE:-crm-unified-ui:dev}
    container_name: ${UI_CONTAINER_NAME:-unified-ui-dev}
    restart: unless-stopped
    profiles:
      - all
      - ui
    ports:
      - "${UI_PORT:-3005}:3005"
    depends_on:
      proposal-bot:
        condition: service_healthy
        required: false
    env_file:
      - ${UI_ENV_FILE:-../.env.development}
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 3005
      SALES_BOT_URL: ${SALES_BOT_URL:-http://proposal-bot:8000}
      ASSET_MGMT_URL: ${ASSET_MGMT_URL:-http://asset-management:8001}
      SECURITY_SERVICE_URL: ${SECURITY_SERVICE_URL:-http://security-service:8002}
      PROXY_SECRET: ${PROXY_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
    volumes:
      - ${UI_UPLOADS_PATH:-../src/unified-ui/uploads}:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-15s}
    networks:
      - crm-network

  # ===========================================================================
  # Asset Management Backend (FastAPI)
  # ===========================================================================
  asset-management:
    build:
      context: ../src/asset-management
      dockerfile: render/Dockerfile  # Render-style Dockerfile for dev/staging
      args:
        - ENVIRONMENT=${ENVIRONMENT:-development}
    image: ${ASSETS_IMAGE:-crm-asset-management:dev}
    container_name: ${ASSETS_CONTAINER_NAME:-asset-management-dev}
    restart: unless-stopped
    profiles:
      - all
      - assets
    ports:
      - "${ASSETS_PORT:-8001}:8001"
    env_file:
      - ${ASSETS_ENV_FILE:-../.env.development}
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8001
      DB_BACKEND: supabase
      PROXY_SECRET: ${PROXY_SECRET}
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Security Service (FastAPI) - Auth/RBAC/Audit
  # ===========================================================================
  security-service:
    build:
      context: ../src/security-service
      dockerfile: render/Dockerfile  # Render-style Dockerfile for dev/staging
      args:
        - ENVIRONMENT=${ENVIRONMENT:-development}
    image: ${SECURITY_IMAGE:-crm-security-service:dev}
    container_name: ${SECURITY_CONTAINER_NAME:-security-service-dev}
    restart: unless-stopped
    profiles:
      - all
      - security
    ports:
      - "${SECURITY_PORT:-8002}:8002"
    env_file:
      - ${SECURITY_ENV_FILE:-../.env.development}
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8002
      SERVICE_NAME: security-service
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Video Critique (FastAPI)
  # ===========================================================================
  video-critique:
    build:
      context: ../src/video-critique
      dockerfile: render/Dockerfile  # Render-style Dockerfile for dev/staging
      args:
        - ENVIRONMENT=${ENVIRONMENT:-development}
    image: ${VIDEO_IMAGE:-crm-video-critique:dev}
    container_name: ${VIDEO_CONTAINER_NAME:-video-critique-dev}
    restart: unless-stopped
    profiles:
      - all
      - video
    ports:
      - "${VIDEO_PORT:-8003}:8003"
    env_file:
      - ${VIDEO_ENV_FILE:-../.env.development}
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8003
      DB_BACKEND: supabase
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  sales-data-dev:
    name: ${SALES_DATA_VOLUME_NAME:-crm-sales-data-dev}

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  crm-network:
    driver: bridge
    name: ${NETWORK_NAME:-crm-network-dev}
