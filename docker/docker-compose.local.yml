# =============================================================================
# MMG Service Platform - LOCAL DEVELOPMENT Docker Compose
# =============================================================================
# FOR: Local development and testing on your machine
# DOCKERFILE: Uses local/Dockerfile in each service directory
#
# DO NOT USE FOR:
# - Production deployments (use docker-compose.yml)
# - Render deployments (use render.yaml in each service)
#
# QUICK START (run from repo root):
#   docker-compose -f docker/docker-compose.local.yml --env-file .env.secrets up -d
#   docker-compose -f docker/docker-compose.local.yml --env-file .env.secrets up -d --build
#
# SELECTIVE SERVICES (using profiles):
#   docker-compose -f docker/docker-compose.local.yml --profile sales up -d
#   docker-compose -f docker/docker-compose.local.yml --profile ui up -d
#   docker-compose -f docker/docker-compose.local.yml --profile assets up -d
#   docker-compose -f docker/docker-compose.local.yml --profile security up -d
#   docker-compose -f docker/docker-compose.local.yml --profile video up -d
#   docker-compose -f docker/docker-compose.local.yml --profile all up -d
#
# CUSTOM PORTS (via environment or .env.secrets):
#   SALES_PORT=9000 UI_PORT=4000 docker-compose -f docker/docker-compose.local.yml up -d
#
# LOGS & MANAGEMENT:
#   docker-compose -f docker/docker-compose.local.yml logs -f
#   docker-compose -f docker/docker-compose.local.yml logs -f proposal-bot
#   docker-compose -f docker/docker-compose.local.yml logs -f unified-ui
#   docker-compose -f docker/docker-compose.local.yml down
#   docker-compose -f docker/docker-compose.local.yml down -v
#
# ACCESS POINTS (default ports):
#   - Unified UI:        http://localhost:3005
#   - Proposal Bot:      http://localhost:8000
#   - Asset Management:  http://localhost:8001
#   - Security Service:  http://localhost:8002
#   - Video Critique:    http://localhost:8003
#   - API Docs:          http://localhost:8000/docs (with dev auth)
#
# =============================================================================
# DEV AUTH SETUP - Testing API directly via Swagger UI (/docs)
# =============================================================================
# 1. Set these in your .env.secrets:
#      DEV_AUTH_ENABLED=true
#      DEV_AUTH_TOKEN=your-secret-token
#
# 2. Go to http://localhost:8000/docs
# 3. Click the "Authorize" button (lock icon, top right)
# 4. Enter your token in the "DevToken" field
# 5. Click Authorize -> Close
# 6. All requests will now include the auth header automatically
# =============================================================================

services:
  # ===========================================================================
  # Proposal Bot Backend (FastAPI) - Sales Module
  # ===========================================================================
  proposal-bot:
    build:
      context: ../src/sales-module
      dockerfile: local/Dockerfile  # Local development Dockerfile
    container_name: ${SALES_CONTAINER_NAME:-proposal-bot}
    restart: unless-stopped
    profiles:
      - all
      - sales
    ports:
      - "${SALES_PORT:-8000}:8000"
    env_file:
      - ../.env.secrets
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8000
      DB_BACKEND: supabase
      STORAGE_PROVIDER: supabase
      AUTH_PROVIDER: supabase
      PROXY_SECRET: ${PROXY_SECRET:-local-dev-proxy-secret-change-me}
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      DEV_AUTH_ENABLED: ${DEV_AUTH_ENABLED:-false}
      DEV_AUTH_TOKEN: ${DEV_AUTH_TOKEN:-dev-test-token}
      DEV_AUTH_USER_EMAIL: ${DEV_AUTH_USER_EMAIL:-dev@test.local}
      DEV_AUTH_USER_PROFILE: ${DEV_AUTH_USER_PROFILE:-system_admin}
      DEV_AUTH_USER_PERMISSIONS: ${DEV_AUTH_USER_PERMISSIONS:-["*:*:*"]}
      DEV_AUTH_USER_COMPANIES: ${DEV_AUTH_USER_COMPANIES:-["backlite_dubai"]}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ../src/sales-module/data:/app/data
      - ../src/sales-module/uploads:/app/uploads
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Unified UI Frontend (FastAPI) - Auth Gateway + SPA
  # ===========================================================================
  unified-ui:
    build:
      context: ../src/unified-ui
      dockerfile: local/Dockerfile  # Local development Dockerfile
    container_name: ${UI_CONTAINER_NAME:-unified-ui}
    restart: unless-stopped
    profiles:
      - all
      - ui
    ports:
      - "${UI_PORT:-3005}:3005"
    depends_on:
      proposal-bot:
        condition: service_healthy
        required: false
    env_file:
      - ../.env.secrets
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 3005
      SALES_BOT_URL: ${SALES_BOT_URL:-http://proposal-bot:8000}
      ASSET_MGMT_URL: ${ASSET_MGMT_URL:-http://asset-management:8001}
      SECURITY_SERVICE_URL: ${SECURITY_SERVICE_URL:-http://security-service:8002}
      PROXY_SECRET: ${PROXY_SECRET:-local-dev-proxy-secret-change-me}
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ../src/unified-ui/uploads:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-15s}
    networks:
      - crm-network

  # ===========================================================================
  # Asset Management Backend (FastAPI)
  # ===========================================================================
  asset-management:
    build:
      context: ../src/asset-management
      dockerfile: local/Dockerfile  # Local development Dockerfile
    container_name: ${ASSETS_CONTAINER_NAME:-asset-management}
    restart: unless-stopped
    profiles:
      - all
      - assets
    ports:
      - "${ASSETS_PORT:-8001}:8001"
    env_file:
      - ../.env.secrets
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8001
      DB_BACKEND: supabase
      PROXY_SECRET: ${PROXY_SECRET:-local-dev-proxy-secret-change-me}
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Security Service (FastAPI) - Auth/RBAC/Audit
  # ===========================================================================
  security-service:
    build:
      context: ../src/security-service
      dockerfile: local/Dockerfile  # Local development Dockerfile
    container_name: ${SECURITY_CONTAINER_NAME:-security-service}
    restart: unless-stopped
    profiles:
      - all
      - security
    ports:
      - "${SECURITY_PORT:-8002}:8002"
    env_file:
      - ../.env.secrets
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8002
      SERVICE_NAME: security-service
      SERVICE_API_SECRET: ${SERVICE_API_SECRET:-}
      SECURITY_DEV_SUPABASE_URL: ${SECURITY_DEV_SUPABASE_URL:-}
      SECURITY_DEV_SUPABASE_SERVICE_KEY: ${SECURITY_DEV_SUPABASE_SERVICE_KEY:-}
      SECURITY_PROD_SUPABASE_URL: ${SECURITY_PROD_SUPABASE_URL:-}
      SECURITY_PROD_SUPABASE_SERVICE_KEY: ${SECURITY_PROD_SUPABASE_SERVICE_KEY:-}
      UI_DEV_SUPABASE_URL: ${UI_DEV_SUPABASE_URL:-}
      UI_DEV_SUPABASE_SERVICE_KEY: ${UI_DEV_SUPABASE_SERVICE_KEY:-}
      UI_PROD_SUPABASE_URL: ${UI_PROD_SUPABASE_URL:-}
      UI_PROD_SUPABASE_SERVICE_KEY: ${UI_PROD_SUPABASE_SERVICE_KEY:-}
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Video Critique (FastAPI)
  # ===========================================================================
  video-critique:
    build:
      context: ../src/video-critique
      dockerfile: local/Dockerfile  # Local development Dockerfile
    container_name: ${VIDEO_CONTAINER_NAME:-video-critique}
    restart: unless-stopped
    profiles:
      - all
      - video
    ports:
      - "${VIDEO_PORT:-8003}:8003"
    env_file:
      - ../.env.secrets
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8003
      DB_BACKEND: supabase
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  crm-network:
    driver: bridge
    name: ${NETWORK_NAME:-crm-network-local}
