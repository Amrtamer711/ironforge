# =============================================================================
# CRM Platform - Local Development Stack
# =============================================================================
# Flexible Docker Compose for local development with cloud Dev Supabase.
#
# QUICK START:
#   docker-compose -f docker/docker-compose.local.yml --env-file .env.secrets up -d
#
# SELECTIVE SERVICES (using profiles):
#   docker-compose -f docker-compose.local.yml --profile sales up -d     # Only sales
#   docker-compose -f docker-compose.local.yml --profile ui up -d        # Only UI
#   docker-compose -f docker-compose.local.yml --profile video up -d     # Only video-critique
#   docker-compose -f docker-compose.local.yml --profile all up -d       # All services
#
# CUSTOM PORTS (via environment or .env.secrets):
#   SALES_PORT=9000 UI_PORT=4000 docker-compose -f docker-compose.local.yml up -d
#
# LOGS & MANAGEMENT:
#   docker-compose -f docker-compose.local.yml logs -f                   # All logs
#   docker-compose -f docker-compose.local.yml logs -f proposal-bot      # Sales only
#   docker-compose -f docker-compose.local.yml logs -f unified-ui        # UI only
#   docker-compose -f docker-compose.local.yml down                      # Stop all
#   docker-compose -f docker-compose.local.yml down -v                   # Stop + remove volumes
#
# ACCESS POINTS (default ports):
#   - Unified UI:     http://localhost:3005 (or $UI_PORT)
#   - Proposal Bot:   http://localhost:8000 (or $SALES_PORT)
#   - Video Critique: http://localhost:8003 (or $VIDEO_PORT)
#   - API Docs:       http://localhost:8000/docs (with dev auth)
#
# =============================================================================
# ENVIRONMENT VARIABLES (set in .env.secrets or shell)
# =============================================================================
#
# Port Configuration:
#   SALES_PORT          External port for sales module (default: 8000)
#   UI_PORT             External port for unified-ui (default: 3005)
#   VIDEO_PORT          External port for video-critique (default: 8003)
#
# Environment:
#   ENVIRONMENT         development | production | local (default: development)
#
# Dev Auth (for testing API via Swagger /docs):
#   DEV_AUTH_ENABLED    true | false (default: false)
#   DEV_AUTH_TOKEN      Token to use in Swagger "Authorize" (default: dev-test-token)
#   DEV_AUTH_USER_EMAIL Test user email (default: dev@test.local)
#   DEV_AUTH_USER_PROFILE Test user profile (default: system_admin)
#   DEV_AUTH_USER_PERMISSIONS Test user permissions (default: ["*:*:*"])
#   DEV_AUTH_USER_COMPANIES Test user companies (default: ["backlite_dubai"])
#
# Proxy (must match between services):
#   PROXY_SECRET        Shared secret for trusted headers
#
# =============================================================================
# DEV AUTH SETUP - Testing API directly via Swagger UI (/docs)
# =============================================================================
# 1. Set these in your .env.secrets:
#      DEV_AUTH_ENABLED=true
#      DEV_AUTH_TOKEN=your-secret-token
#
# 2. Go to http://localhost:8000/docs
# 3. Click the "Authorize" button (lock icon, top right)
# 4. Enter your token in the "DevToken" field
# 5. Click Authorize -> Close
# 6. All requests will now include the auth header automatically
# =============================================================================

services:
  # ===========================================================================
  # Proposal Bot Backend (FastAPI) - Sales Module
  # ===========================================================================
  proposal-bot:
    build:
      context: ../src/sales-module
      dockerfile: Dockerfile
    container_name: ${SALES_CONTAINER_NAME:-proposal-bot}
    restart: unless-stopped
    profiles:
      - all
      - sales
    ports:
      - "${SALES_PORT:-8000}:8000"
    env_file:
      - ../.env.secrets
    environment:
      # Core settings
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8000

      # Database & storage (use cloud Supabase)
      DB_BACKEND: supabase
      STORAGE_PROVIDER: supabase
      AUTH_PROVIDER: supabase

      # Proxy secret for trusted headers
      PROXY_SECRET: ${PROXY_SECRET:-local-dev-proxy-secret-change-me}

      # CORS - set via env var or defaults to allow all in development
      CORS_ORIGINS: ${CORS_ORIGINS:-}

      # Dev auth for testing API via /docs
      DEV_AUTH_ENABLED: ${DEV_AUTH_ENABLED:-false}
      DEV_AUTH_TOKEN: ${DEV_AUTH_TOKEN:-dev-test-token}
      DEV_AUTH_USER_EMAIL: ${DEV_AUTH_USER_EMAIL:-dev@test.local}
      DEV_AUTH_USER_PROFILE: ${DEV_AUTH_USER_PROFILE:-system_admin}
      DEV_AUTH_USER_PERMISSIONS: ${DEV_AUTH_USER_PERMISSIONS:-["*:*:*"]}
      DEV_AUTH_USER_COMPANIES: ${DEV_AUTH_USER_COMPANIES:-["backlite_dubai"]}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ../src/sales-module/data:/app/data
      - ../src/sales-module/uploads:/app/uploads
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Unified UI Frontend (FastAPI) - Auth Gateway + SPA
  # ===========================================================================
  unified-ui:
    build:
      context: ../src/unified-ui
      dockerfile: Dockerfile
    container_name: ${UI_CONTAINER_NAME:-unified-ui}
    restart: unless-stopped
    profiles:
      - all
      - ui
    ports:
      - "${UI_PORT:-3005}:3005"
    depends_on:
      proposal-bot:
        condition: service_healthy
        required: false  # Allow running UI standalone
    env_file:
      - ../.env.secrets
    environment:
      # Core settings
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 3005

      # Proxy to proposal-bot (use Docker DNS or external URL)
      SALES_BOT_URL: ${SALES_BOT_URL:-http://proposal-bot:8000}

      # Must match proposal-bot
      PROXY_SECRET: ${PROXY_SECRET:-local-dev-proxy-secret-change-me}

      # CORS - set via env var or defaults to allow all in development
      CORS_ORIGINS: ${CORS_ORIGINS:-}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ../src/unified-ui/uploads:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-15s}
    networks:
      - crm-network

  # ===========================================================================
  # Asset Management Backend (FastAPI) - Centralized Asset/Location Management
  # ===========================================================================
  asset-management:
    build:
      context: ../src/asset-management
      dockerfile: Dockerfile
    container_name: ${ASSETS_CONTAINER_NAME:-asset-management}
    restart: unless-stopped
    profiles:
      - all
      - assets
    ports:
      - "${ASSETS_PORT:-8001}:8001"
    env_file:
      - ../.env.secrets
    environment:
      # Core settings
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8001

      # Database (Supabase)
      DB_BACKEND: supabase

      # CORS - set via env var or defaults to allow all in development
      CORS_ORIGINS: ${CORS_ORIGINS:-}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Security Service (FastAPI) - Centralized Auth/RBAC/Audit
  # ===========================================================================
  security-service:
    build:
      context: ../src/security-service
      dockerfile: Dockerfile
    container_name: ${SECURITY_CONTAINER_NAME:-security-service}
    restart: unless-stopped
    profiles:
      - all
      - security
    ports:
      - "${SECURITY_PORT:-8002}:8002"
    env_file:
      - ../.env.secrets
    environment:
      # Core settings
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8002

      # Service identification
      SERVICE_NAME: security-service
      SERVICE_API_SECRET: ${SERVICE_API_SECRET:-}

      # Security Supabase (owns audit_logs, api_keys, etc.)
      SECURITY_DEV_SUPABASE_URL: ${SECURITY_DEV_SUPABASE_URL:-}
      SECURITY_DEV_SUPABASE_SERVICE_KEY: ${SECURITY_DEV_SUPABASE_SERVICE_KEY:-}
      SECURITY_PROD_SUPABASE_URL: ${SECURITY_PROD_SUPABASE_URL:-}
      SECURITY_PROD_SUPABASE_SERVICE_KEY: ${SECURITY_PROD_SUPABASE_SERVICE_KEY:-}

      # UI Supabase (read-only for user/profile lookups)
      UI_DEV_SUPABASE_URL: ${UI_DEV_SUPABASE_URL:-}
      UI_DEV_SUPABASE_SERVICE_KEY: ${UI_DEV_SUPABASE_SERVICE_KEY:-}
      UI_PROD_SUPABASE_URL: ${UI_PROD_SUPABASE_URL:-}
      UI_PROD_SUPABASE_SERVICE_KEY: ${UI_PROD_SUPABASE_SERVICE_KEY:-}

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

  # ===========================================================================
  # Video Critique (FastAPI) - Video Production Workflow Management
  # ===========================================================================
  video-critique:
    build:
      context: ../src/video-critique
      dockerfile: Dockerfile
    container_name: ${VIDEO_CONTAINER_NAME:-video-critique}
    restart: unless-stopped
    profiles:
      - all
      - video
    ports:
      - "${VIDEO_PORT:-8003}:8003"
    env_file:
      - ../.env.secrets
    environment:
      # Core settings
      ENVIRONMENT: ${ENVIRONMENT:-development}
      PORT: 8003

      # Database (Supabase)
      DB_BACKEND: supabase

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-3}
      start_period: ${HEALTHCHECK_START_PERIOD:-30s}
    networks:
      - crm-network

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  crm-network:
    driver: bridge
    name: ${NETWORK_NAME:-crm-network-local}
