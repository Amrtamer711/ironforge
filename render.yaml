# =============================================================================
# Render Blueprint - CRM (Ironforge)
# =============================================================================
# Deploy all CRM services with a single Blueprint deployment.
#
# PRODUCTION (main branch):
#   - ENVIRONMENT=production
#   - Uses *_PROD_SUPABASE_* keys
#   - Deployed to https://mmg-nova.com
#
# DEVELOPMENT (dev branch):
#   - ENVIRONMENT=development
#   - Uses *_DEV_SUPABASE_* keys
#   - Deployed to crm-*-dev.onrender.com
#
# To deploy:
# 1. Go to https://dashboard.render.com
# 2. Click "New" â†’ "Blueprint"
# 3. Select the ironforge repo
# 4. Select the branch (main for prod, dev for development)
# 5. Render will read this file and create all services
# =============================================================================

services:
  # ===========================================================================
  # Unified UI - Main Frontend + API Gateway
  # ===========================================================================
  - type: web
    name: crm-unified-ui
    runtime: docker
    region: singapore
    plan: starter
    branch: main
    rootDir: ""
    dockerfilePath: ./src/unified-ui/Dockerfile
    dockerContext: .
    healthCheckPath: /health
    autoDeploy: true
    disk:
      name: unified-ui-data
      mountPath: /app/data
      sizeGB: 1
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: "3005"
      - key: SALES_BOT_URL
        sync: false
      # Production Supabase (UI project)
      - key: UI_PROD_SUPABASE_URL
        sync: false
      - key: UI_PROD_SUPABASE_ANON_KEY
        sync: false
      - key: UI_PROD_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Development Supabase (kept for local dev)
      - key: UI_DEV_SUPABASE_URL
        sync: false
      - key: UI_DEV_SUPABASE_ANON_KEY
        sync: false
      - key: UI_DEV_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: SECURITY_SERVICE_URL
        sync: false
      - key: INTER_SERVICE_SECRET
        sync: false
      - key: REDIS_URL
        sync: false

  # ===========================================================================
  # Security Service - Auth, API Keys, RBAC
  # ===========================================================================
  - type: web
    name: crm-security-service
    runtime: docker
    region: singapore
    plan: starter
    branch: main
    rootDir: src/security-service
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: "8002"
      # Production Supabase (Security project)
      - key: SECURITY_PROD_SUPABASE_URL
        sync: false
      - key: SECURITY_PROD_SUPABASE_ANON_KEY
        sync: false
      - key: SECURITY_PROD_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Production Supabase (UI project - for user lookups)
      - key: UI_PROD_SUPABASE_URL
        sync: false
      - key: UI_PROD_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Development keys (kept for local dev)
      - key: SECURITY_DEV_SUPABASE_URL
        sync: false
      - key: SECURITY_DEV_SUPABASE_ANON_KEY
        sync: false
      - key: SECURITY_DEV_SUPABASE_SERVICE_KEY
        sync: false
      - key: INTER_SERVICE_SECRET
        sync: false
      - key: REDIS_URL
        sync: false

  # ===========================================================================
  # Asset Management - Location & Media Assets
  # ===========================================================================
  - type: web
    name: crm-asset-management
    runtime: docker
    region: singapore
    plan: pro
    branch: main
    rootDir: src/asset-management
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: "8001"
      # Production Supabase (Asset Management project)
      - key: ASSETMGMT_PROD_SUPABASE_URL
        sync: false
      - key: ASSETMGMT_PROD_SUPABASE_ANON_KEY
        sync: false
      - key: ASSETMGMT_PROD_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Development keys (kept for local dev)
      - key: ASSETMGMT_DEV_SUPABASE_URL
        sync: false
      - key: ASSETMGMT_DEV_SUPABASE_ANON_KEY
        sync: false
      - key: ASSETMGMT_DEV_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DB_BACKEND
        value: supabase
      - key: INTER_SERVICE_SECRET
        sync: false
      - key: REDIS_URL
        sync: false

  # ===========================================================================
  # Sales Module - Proposals & Contracts
  # ===========================================================================
  - type: web
    name: crm-sales-module
    runtime: docker
    region: singapore
    plan: pro_plus
    branch: main
    rootDir: src/sales-module
    dockerfilePath: ./render/Dockerfile
    dockerContext: .
    healthCheckPath: /health
    autoDeploy: true
    disk:
      name: sales-module-data
      mountPath: /data
      sizeGB: 5
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: "8000"
      # Production Supabase (Salesbot project)
      - key: SALESBOT_PROD_SUPABASE_URL
        sync: false
      - key: SALESBOT_PROD_SUPABASE_ANON_KEY
        sync: false
      - key: SALESBOT_PROD_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      # Development keys (kept for local dev)
      - key: SALESBOT_DEV_SUPABASE_URL
        sync: false
      - key: SALESBOT_DEV_SUPABASE_ANON_KEY
        sync: false
      - key: SALESBOT_DEV_SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: DB_BACKEND
        value: supabase
      - key: AUTH_PROVIDER
        value: supabase
      - key: INTER_SERVICE_SECRET
        sync: false
      - key: REDIS_URL
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: ANTHROPIC_API_KEY
        sync: false

  # ===========================================================================
  # Video Critique - Video Review Workflow
  # ===========================================================================
  - type: web
    name: crm-video-critique
    runtime: docker
    region: singapore
    plan: starter
    branch: main
    rootDir: src/video-critique
    dockerfilePath: ./Dockerfile
    dockerContext: .
    healthCheckPath: /health
    autoDeploy: true
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: PORT
        value: "8003"
      - key: IS_PRODUCTION
        value: "true"
      - key: DROPBOX_ACCESS_TOKEN
        sync: false
      - key: TRELLO_API_KEY
        sync: false
      - key: TRELLO_TOKEN
        sync: false
      - key: INTER_SERVICE_SECRET
        sync: false
