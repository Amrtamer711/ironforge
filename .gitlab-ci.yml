# GitLab CI/CD configuration for Proposal Bot API
#
# This file is ready for when you migrate to GitLab.
# Currently using GitHub Actions (.github/workflows/ci.yml)
#
# Runs on:
# - All pushes to main/dev branches
# - All merge requests to main/dev branches
#
# Stages:
# - lint: Code quality checks (ruff, bandit)
# - test: Run pytest with coverage
# - build: Verify Docker build works

stages:
  - lint
  - test
  - build

variables:
  PYTHON_VERSION: "3.10"
  NODE_VERSION: "18"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

# Cache pip packages between jobs
.python-cache: &python-cache
  cache:
    key: python-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/pip
      - venv/

# ==============================================================================
# LINT STAGE - Code quality checks
# ==============================================================================
lint:python:
  stage: lint
  image: python:${PYTHON_VERSION}
  <<: *python-cache
  script:
    - python -m pip install --upgrade pip
    - pip install ruff bandit
    - ruff check . --output-format=text
    - ruff format --check .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"

security:bandit:
  stage: lint
  image: python:${PYTHON_VERSION}
  <<: *python-cache
  script:
    - python -m pip install --upgrade pip
    - pip install bandit[toml]
    - bandit -c pyproject.toml -r api/ db/ integrations/ generators/ utils/ workflows/ -f txt
  allow_failure: true  # Don't fail pipeline on security warnings, just report
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"

lint:ui:
  stage: lint
  image: node:${NODE_VERSION}
  cache:
    key: node-${CI_COMMIT_REF_SLUG}
    paths:
      - unified-ui/node_modules/
  script:
    - cd unified-ui
    - npm ci
    - node --check server.js
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"

# ==============================================================================
# TEST STAGE - Run pytest
# ==============================================================================
test:python:
  stage: test
  image: python:${PYTHON_VERSION}
  <<: *python-cache
  variables:
    ENVIRONMENT: test
    DB_BACKEND: sqlite
    AUTH_PROVIDER: static
    RBAC_PROVIDER: static
    OPENAI_API_KEY: test-key
    SLACK_BOT_TOKEN: ""
    SLACK_SIGNING_SECRET: ""
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-asyncio pytest-cov httpx
    - mkdir -p data/templates db
  script:
    - pytest tests/
        --cov=api --cov=db --cov=integrations
        --cov-report=xml
        --cov-report=term-missing
        -v
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"

# ==============================================================================
# BUILD STAGE - Verify Docker build
# ==============================================================================
build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker info
  script:
    - docker build -t proposal-bot:test .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"
