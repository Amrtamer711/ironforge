stages:
  - build
  - gitops

variables:
  AWS_REGION: "eu-north-1"
  AWS_ACCOUNT_ID: "018881300778"
  ECR_REGISTRY: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

  # Docker-in-Docker
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""

  # Image tagging
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"

# Template job all services extend
.build_push_ecr_template:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
  id_tokens:
    AWS_ID_TOKEN:
      aud: "https://gitlab.com"   # must match the trust policy "aud" you set in AWS
  before_script:
    - apk add --no-cache aws-cli jq
    - aws --version

    # Assume AWS role using GitLab OIDC token
    - |
      CREDS=$(aws sts assume-role-with-web-identity \
        --role-arn "$AWS_ROLE_ARN" \
        --role-session-name "gitlab-${CI_PROJECT_PATH_SLUG}-${CI_PIPELINE_ID}" \
        --web-identity-token "$AWS_ID_TOKEN" \
        --duration-seconds 3600)

      export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r '.Credentials.AccessKeyId')
      export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r '.Credentials.SecretAccessKey')
      export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r '.Credentials.SessionToken')

    # Login to ECR
    - aws ecr get-login-password --region "$AWS_REGION" |
      docker login --username AWS --password-stdin "$ECR_REGISTRY"

  script:
    - echo "Building ${SERVICE_NAME} from ${SERVICE_DIR}"
    - docker build -f "${DOCKERFILE_PATH:-${SERVICE_DIR}/Dockerfile}" -t "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}" "${BUILD_CONTEXT:-.}"
    - docker push "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

    # Intentionally do not push moving tags (like :latest/:demo).
    # Argo CD auto-updates using argocd-image-updater by selecting the newest build tag.

include:
  - local: "src/unified-ui/ci-cd.yml"
  - local: "src/sales-module/ci-cd.yml"
  - local: "src/security-service/ci-cd.yml"
  - local: "src/asset-management/ci-cd.yml"
  - local: "src/video-critique/ci-cd.yml"

# GitOps (MR-based): create a branch that bumps the deployed image tag and open a Merge Request.
# Requires a CI variable `GITLAB_BOT_TOKEN` with permission to push branches and create merge requests.
gitops_mr_unifiedui_dev:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "demo"
  rules:
    - if: '$CI_COMMIT_BRANCH == "demo" && $GITLAB_BOT_TOKEN'
      changes:
        - src/unified-ui/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/unifiedui/overlays/dev/kustomization.yaml"
      BRANCH="gitops/unifiedui-dev-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump Unified UI dev image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      # Do NOT use [skip ci] here; we want a verifiable MR pipeline.
      git commit -m "deploy(unifiedui-dev): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy unifiedui-dev: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

# Minimal job so the MR branch has a passing pipeline (merge checks stay green).
gitops_mr_noop:
  stage: gitops
  image: alpine:3.20
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^gitops\\//'
      when: on_success
    - when: never
  script:
    - echo "GitOps MR branch pipeline OK"

# GitOps (MR-based): bump the deployed sales-module image tag (proposal-bot) and open a Merge Request.
gitops_mr_sales_dev:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "demo"
  rules:
    - if: '$CI_COMMIT_BRANCH == "demo" && $GITLAB_BOT_TOKEN'
      changes:
        - src/sales-module/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/sales-module/overlays/dev/kustomization.yaml"
      BRANCH="gitops/sales-dev-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump sales-module dev image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(sales-dev): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy sales-dev: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

# GitOps (MR-based): bump the deployed security-service image tag and open a Merge Request.
gitops_mr_security_dev:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "demo"
  rules:
    - if: '$CI_COMMIT_BRANCH == "demo" && $GITLAB_BOT_TOKEN'
      changes:
        - src/security-service/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/security-service/overlays/dev/kustomization.yaml"
      BRANCH="gitops/security-dev-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump security-service dev image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(security-dev): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy security-dev: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

# GitOps (MR-based): bump the deployed asset-management image tag and open a Merge Request.
gitops_mr_assetmgmt_dev:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "demo"
  rules:
    - if: '$CI_COMMIT_BRANCH == "demo" && $GITLAB_BOT_TOKEN'
      changes:
        - src/asset-management/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/asset-management/overlays/dev/kustomization.yaml"
      BRANCH="gitops/assetmgmt-dev-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump asset-management dev image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(assetmgmt-dev): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy assetmgmt-dev: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

# GitOps (MR-based): bump the deployed video-critique image tag and open a Merge Request.
gitops_mr_videocritique_dev:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "demo"
  rules:
    - if: '$CI_COMMIT_BRANCH == "demo" && $GITLAB_BOT_TOKEN'
      changes:
        - src/video-critique/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/video-critique/overlays/dev/kustomization.yaml"
      BRANCH="gitops/videocritique-dev-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump video-critique dev image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(videocritique-dev): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy videocritique-dev: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

# -----------------------------------------------------------------------------
# GitOps (MR-based): staging (branch == staging) -> deploy overlays/staging
# -----------------------------------------------------------------------------

gitops_mr_unifiedui_staging:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "staging"
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging" && $GITLAB_BOT_TOKEN'
      changes:
        - src/unified-ui/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/unifiedui/overlays/staging/kustomization.yaml"
      BRANCH="gitops/unifiedui-staging-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump unifiedui staging image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(unifiedui-staging): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy unifiedui-staging: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_sales_staging:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "staging"
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging" && $GITLAB_BOT_TOKEN'
      changes:
        - src/sales-module/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/sales-module/overlays/staging/kustomization.yaml"
      BRANCH="gitops/sales-staging-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump sales staging image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(sales-staging): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy sales-staging: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_security_staging:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "staging"
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging" && $GITLAB_BOT_TOKEN'
      changes:
        - src/security-service/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/security-service/overlays/staging/kustomization.yaml"
      BRANCH="gitops/security-staging-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump security-service staging image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(security-staging): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy security-staging: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_assetmgmt_staging:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "staging"
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging" && $GITLAB_BOT_TOKEN'
      changes:
        - src/asset-management/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/asset-management/overlays/staging/kustomization.yaml"
      BRANCH="gitops/assetmgmt-staging-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump asset-management staging image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(assetmgmt-staging): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy assetmgmt-staging: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_videocritique_staging:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "staging"
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging" && $GITLAB_BOT_TOKEN'
      changes:
        - src/video-critique/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/video-critique/overlays/staging/kustomization.yaml"
      BRANCH="gitops/videocritique-staging-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump video-critique staging image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(videocritique-staging): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy videocritique-staging: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

# -----------------------------------------------------------------------------
# GitOps (MR-based): production (branch == main) -> deploy overlays/production
# -----------------------------------------------------------------------------

gitops_mr_unifiedui_production:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "main"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $GITLAB_BOT_TOKEN'
      changes:
        - src/unified-ui/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/unifiedui/overlays/production/kustomization.yaml"
      BRANCH="gitops/unifiedui-production-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump unifiedui production image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(unifiedui-production): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy unifiedui-production: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_sales_production:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "main"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $GITLAB_BOT_TOKEN'
      changes:
        - src/sales-module/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/sales-module/overlays/production/kustomization.yaml"
      BRANCH="gitops/sales-production-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump sales production image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(sales-production): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy sales-production: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_security_production:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "main"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $GITLAB_BOT_TOKEN'
      changes:
        - src/security-service/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/security-service/overlays/production/kustomization.yaml"
      BRANCH="gitops/security-production-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump security-service production image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(security-production): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy security-production: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_assetmgmt_production:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "main"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $GITLAB_BOT_TOKEN'
      changes:
        - src/asset-management/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/asset-management/overlays/production/kustomization.yaml"
      BRANCH="gitops/assetmgmt-production-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump asset-management production image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(assetmgmt-production): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy assetmgmt-production: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"

gitops_mr_videocritique_production:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
    GITOPS_BASE_BRANCH: "main"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $GITLAB_BOT_TOKEN'
      changes:
        - src/video-critique/**/*
        - src/shared/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - |
      set -euo pipefail

      FILE="src/platform/deploy/kustomize/video-critique/overlays/production/kustomization.yaml"
      BRANCH="gitops/videocritique-production-${CI_COMMIT_SHORT_SHA}"

      echo "Preparing MR to bump video-critique production image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
      git checkout -B "${BRANCH}"
      sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "${FILE}"

      git add "${FILE}"
      if git diff --cached --quiet; then
        echo "No change; skipping"
        exit 0
      fi

      git commit -m "deploy(videocritique-production): ${CI_COMMIT_SHORT_SHA}"

      MR_TITLE="Deploy videocritique-production: ${CI_COMMIT_SHORT_SHA}"
      MR_DESC="Automated GitOps MR generated by CI.\n\nImage tag: ${CI_COMMIT_SHORT_SHA}\nFile: ${FILE}"

      echo "Pushing branch and creating merge request..."
      git push -u "https://oauth2:${GITLAB_BOT_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH}" \
        -o merge_request.create \
        -o "merge_request.target=${GITOPS_BASE_BRANCH}" \
        -o "merge_request.title=${MR_TITLE}" \
        -o "merge_request.description=${MR_DESC}"
