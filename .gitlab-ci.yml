stages:
  - build
  - gitops

variables:
  AWS_REGION: "eu-north-1"
  AWS_ACCOUNT_ID: "018881300778"
  ECR_REGISTRY: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

  # Docker-in-Docker
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""

  # Image tagging
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"

# Template job all services extend
.build_push_ecr_template:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
  id_tokens:
    AWS_ID_TOKEN:
      aud: "https://gitlab.com"   # must match the trust policy "aud" you set in AWS
  before_script:
    - apk add --no-cache aws-cli jq
    - aws --version

    # Assume AWS role using GitLab OIDC token
    - |
      CREDS=$(aws sts assume-role-with-web-identity \
        --role-arn "$AWS_ROLE_ARN" \
        --role-session-name "gitlab-${CI_PROJECT_PATH_SLUG}-${CI_PIPELINE_ID}" \
        --web-identity-token "$AWS_ID_TOKEN" \
        --duration-seconds 3600)

      export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r '.Credentials.AccessKeyId')
      export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r '.Credentials.SecretAccessKey')
      export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r '.Credentials.SessionToken')

    # Login to ECR
    - aws ecr get-login-password --region "$AWS_REGION" |
      docker login --username AWS --password-stdin "$ECR_REGISTRY"

  script:
    - echo "Building ${SERVICE_NAME} from ${SERVICE_DIR}"
    - docker build -f "src/unified-ui/Dockerfile" -t "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}" .
    - docker push "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

    # Intentionally do not push moving tags (like :latest/:demo).
    # Argo CD auto-updates using argocd-image-updater by selecting the newest build tag.

include:
  - local: "src/unified-ui/ci-cd.yml"

# GitOps: write the deployed image tag into the repo (pure GitOps flow).
# Requires a project/group CI variable `GITLAB_PUSH_TOKEN` with permission to push to the branch.
gitops_bump_unifiedui_dev:
  stage: gitops
  image: alpine:3.20
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: "0"
  rules:
    - if: '$CI_COMMIT_BRANCH == "demo" && $GITLAB_PUSH_TOKEN'
      changes:
        - src/unified-ui/**/*
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git
    - git config user.email "ci-bot@mmg.global"
    - git config user.name "mmg-ci-bot"
  script:
    - FILE="src/platform/deploy/kustomize/unifiedui/overlays/dev/kustomization.yaml"
    - echo "Bumping Unified UI dev image tag to ${CI_COMMIT_SHORT_SHA} in ${FILE}"
    - sed -i -E "s/^([[:space:]]*newTag:).*/\\1 ${CI_COMMIT_SHORT_SHA}/" "$FILE"
    - git add "$FILE"
    - git diff --cached --quiet && (echo "No change; skipping" && exit 0)
    - git commit -m "deploy(unifiedui-dev): ${CI_COMMIT_SHORT_SHA} [skip ci]"
    - git push "https://oauth2:${GITLAB_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${CI_COMMIT_BRANCH}"
