stages:
  - build

variables:
  AWS_REGION: "eu-north-1"
  AWS_ACCOUNT_ID: "018881300778"
  ECR_REGISTRY: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

  # Docker-in-Docker
  DOCKER_HOST: "tcp://docker:2375"
  DOCKER_TLS_CERTDIR: ""

  # Image tagging
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"

# Template job all services extend
.build_push_ecr_template:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
  id_tokens:
    AWS_ID_TOKEN:
      aud: "https://gitlab.com"   # must match the trust policy "aud" you set in AWS
  before_script:
    - apk add --no-cache aws-cli jq
    - aws --version

    # Assume AWS role using GitLab OIDC token
    - |
      CREDS=$(aws sts assume-role-with-web-identity \
        --role-arn "$AWS_ROLE_ARN" \
        --role-session-name "gitlab-${CI_PROJECT_PATH_SLUG}-${CI_PIPELINE_ID}" \
        --web-identity-token "$AWS_ID_TOKEN" \
        --duration-seconds 3600)

      export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r '.Credentials.AccessKeyId')
      export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r '.Credentials.SecretAccessKey')
      export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r '.Credentials.SessionToken')

    # Login to ECR
    - aws ecr get-login-password --region "$AWS_REGION" |
      docker login --username AWS --password-stdin "$ECR_REGISTRY"

  script:
    - echo "Building ${SERVICE_NAME} from ${SERVICE_DIR}"
    - docker build -f "src/unified-ui/Dockerfile" -t "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}" .
    - docker push "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}"

    # Push immutable SemVer tags on Git tag pipelines (e.g. v1.2.3 or 1.2.3)
    - |
      if [ -n "${CI_COMMIT_TAG:-}" ]; then
        SEMVER="${CI_COMMIT_TAG#v}"
        if echo "$SEMVER" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "Pushing SemVer tag: ${SEMVER}"
          docker tag "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}" "${ECR_REGISTRY}/${ECR_REPO}:${SEMVER}"
          docker push "${ECR_REGISTRY}/${ECR_REPO}:${SEMVER}"
          # Also update :latest on release tags
          docker tag "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}" "${ECR_REGISTRY}/${ECR_REPO}:latest"
          docker push "${ECR_REGISTRY}/${ECR_REPO}:latest"
        else
          echo "CI_COMMIT_TAG '${CI_COMMIT_TAG}' is not SemVer; skipping SemVer push"
        fi
      fi

    # Push a stable env tag from the demo branch (used by argocd-image-updater to track the latest digest)
    - |
      if [ "$CI_COMMIT_BRANCH" = "demo" ]; then
        docker tag "${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}" "${ECR_REGISTRY}/${ECR_REPO}:demo"
        docker push "${ECR_REGISTRY}/${ECR_REPO}:demo"
      fi

    # Push latest only from default branch
    - |
      echo "Skipping branch-based :latest updates (latest is reserved for SemVer releases)"

include:
  - local: "src/unified-ui/ci-cd.yml"
